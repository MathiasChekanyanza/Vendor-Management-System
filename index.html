<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vendor Management System</title>
  <meta name="description" content="Single-file Vendor Management System (localStorage) â€” deploy to GitHub Pages" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide icons (UMD) -->
  <script src="https://unpkg.com/lucide@1.0.2/dist/umd/lucide.min.js"></script>
  <style>
    /* Small extra transitions not covered by Tailwind CDN */
    .fade-enter { opacity: 0; transform: translateY(6px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); transition: all .18s ease; }
    .modal-bg { backdrop-filter: blur(3px); }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">

  <!-- Header / Login -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-xl font-bold">Vendor Management System</h1>
        <p class="text-blue-100 text-sm">Manage vendor contacts & site images (localStorage)</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="exportBtn" class="hidden md:inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 px-3 py-2 rounded">
          <i data-lucide="download" class="w-4 h-4"></i>
          <span class="text-sm font-medium">Export All</span>
        </button>
        <button id="exportSelectedBtn" class="hidden md:inline-flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 px-3 py-2 rounded">
          <i data-lucide="download" class="w-4 h-4"></i>
          <span class="text-sm font-medium">Export Selected</span>
        </button>
        <button id="addBtn" class="inline-flex items-center gap-2 bg-white text-blue-600 hover:bg-blue-50 px-3 py-2 rounded">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span class="text-sm font-medium">Add Vendor</span>
        </button>
        <button id="logoutBtn" class="ml-2 hidden bg-white text-blue-600 hover:bg-blue-50 px-3 py-2 rounded text-sm">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- Login modal (static/hardcoded) -->
    <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 modal-bg">
      <div class="bg-white rounded-lg shadow p-6 w-full max-w-sm">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">Sign in</h2>
        <p class="text-sm text-gray-500 mb-4">Use the static demo account to access the app.</p>
        <form id="loginForm" class="space-y-3">
          <div>
            <label class="block text-sm text-gray-700">Username</label>
            <input id="loginUser" class="w-full px-3 py-2 border rounded" value="admin" />
          </div>
          <div>
            <label class="block text-sm text-gray-700">Password</label>
            <input id="loginPass" type="password" class="w-full px-3 py-2 border rounded" value="admin123" />
          </div>
          <div class="flex items-center justify-end gap-2">
            <button type="submit" class="bg-blue-600 text-white px-3 py-2 rounded">Sign in</button>
          </div>
          <p class="text-xs text-gray-400">Demo credentials: <strong>admin / admin123</strong></p>
        </form>
      </div>
    </div>

    <!-- Controls: search + mobile actions -->
    <div class="mt-6 mb-4">
      <div class="bg-white rounded-lg p-3 shadow flex flex-col md:flex-row gap-3 items-center">
        <div class="flex-1 w-full relative">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
          <input id="searchInput" placeholder="Search by name, address or phone..." class="w-full pl-10 pr-3 py-2 border rounded focus:outline-none" />
        </div>
        <div class="flex gap-2 w-full md:w-auto">
          <button id="exportBtnMobile" class="md:hidden flex-1 bg-green-500 text-white px-3 py-2 rounded">Export</button>
          <button id="addBtnMobile" class="md:hidden flex-1 bg-blue-600 text-white px-3 py-2 rounded">Add Vendor</button>
        </div>
      </div>
    </div>

    <!-- Loading / Empty / Content -->
    <div id="loading" class="bg-white rounded-lg shadow p-8 text-center">Loading vendors...</div>

    <div id="emptyState" class="hidden bg-white rounded-lg shadow p-8 text-center">
      <div class="text-gray-400 mb-4">
        <i data-lucide="search" class="w-12 h-12 mx-auto"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-700">No vendors yet</h3>
      <p class="text-sm text-gray-500">Click "Add Vendor" to get started.</p>
    </div>

    <section id="vendorGrid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4"></section>
  </main>

  <!-- Modal: Add/Edit Vendor -->
  <div id="formModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 modal-bg">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-5 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 id="formTitle" class="text-lg font-semibold">Add Vendor</h3>
        <button id="closeForm" class="text-gray-600 hover:text-gray-800" title="Close">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="vendorForm" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-700">Vendor Name <span class="text-red-500">*</span></label>
          <input id="nameInput" class="w-full px-3 py-2 border rounded" required />
        </div>
        <div>
          <label class="block text-sm text-gray-700">Address <span class="text-red-500">*</span></label>
          <textarea id="addressInput" class="w-full px-3 py-2 border rounded" rows="3" required></textarea>
        </div>
        <div>
          <label class="block text-sm text-gray-700">Phone <span class="text-red-500">*</span></label>
          <input id="phoneInput" class="w-full px-3 py-2 border rounded" required />
        </div>
        <div>
          <label class="block text-sm text-gray-700">What they do (short)</label>
          <textarea id="activityInput" class="w-full px-3 py-2 border rounded" rows="2" placeholder="E.g. Construction supplier, Catering services, IT support"></textarea>
        </div>
        <div>
          <label class="block text-sm text-gray-700">Site Image (optional)</label>
          <div class="flex items-center gap-3">
            <label class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded cursor-pointer">
              <i data-lucide="upload" class="w-4 h-4"></i>
              Choose Image
              <input id="imageInput" type="file" accept="image/*" class="hidden" />
            </label>
            <button id="removeImageBtn" type="button" class="text-sm text-red-600 hidden">Remove</button>
            <!-- Camera capture (separate from upload) -->
            <label class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded cursor-pointer">
              <i data-lucide="camera" class="w-4 h-4"></i>
              Take Photo
              <input id="cameraInput" type="file" accept="image/*" capture="environment" class="hidden" />
            </label>
            <button id="removeCameraBtn" type="button" class="text-sm text-red-600 hidden">Remove Photo</button>
          </div>
          <img id="imagePreview" src="" alt="Preview" class="mt-3 w-full max-h-56 object-cover rounded hidden" />
          <img id="cameraPreview" src="" alt="Camera Preview" class="mt-3 w-full max-h-40 object-cover rounded hidden" />
          <p id="imageHint" class="text-xs text-gray-400 mt-1">Max size: 2MB. Images stored as base64 in localStorage. "Take Photo" uses your device camera when available.</p>
        </div>
        <div class="flex gap-3">
          <button id="cancelBtn" type="button" class="flex-1 px-3 py-2 border rounded">Cancel</button>
          <button id="saveBtn" type="submit" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded">Save Vendor</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Template for vendor card (cloned) -->
  <template id="vendorCardTpl">
    <article class="bg-white rounded-lg shadow hover:shadow-lg overflow-hidden transition">
      <div class="card-image"></div>
        <div class="p-4">
        <h4 class="font-semibold name text-lg"></h4>
        <p class="text-sm text-gray-600 address mt-1"></p>
        <p class="text-blue-600 font-medium phone mt-2"></p>
        <div class="flex gap-2 mt-3 items-center">
          <button class="callBtn flex-none flex items-center justify-center gap-2 px-2 py-1 bg-green-50 text-green-600 rounded text-sm" title="Call">
            <i data-lucide="phone" class="w-4 h-4"></i>
          </button>
          <button class="waBtn flex-none flex items-center justify-center gap-2 px-2 py-1 bg-green-50 text-green-700 rounded text-sm" title="WhatsApp">
            <i data-lucide="message-circle" class="w-4 h-4"></i>
          </button>
          <button class="exportVendorBtn flex-none flex items-center justify-center gap-2 px-2 py-1 bg-gray-100 text-gray-700 rounded text-sm" title="Export vendor">
            <i data-lucide="download" class="w-4 h-4"></i>
          </button>
          <div class="flex-1"></div>
          <button class="editBtn flex-1 flex items-center justify-center gap-2 px-2 py-2 bg-blue-50 text-blue-600 rounded"> <i data-lucide="edit-2" class="w-4 h-4"></i> Edit</button>
          <button class="deleteBtn flex-1 flex items-center justify-center gap-2 px-2 py-2 bg-red-50 text-red-600 rounded"> <i data-lucide="trash-2" class="w-4 h-4"></i> Delete</button>
        </div>
      </div>
    </article>
  </template>

  <script>
    // Initialize lucide icons
    document.addEventListener('DOMContentLoaded', () => lucide && lucide.createIcons());

    // Simple static login (session-based)
    const LOGIN_KEY = 'vms_logged_in';
    const DEMO_USER = { username: 'admin', password: 'admin123' };

    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const logoutBtn = document.getElementById('logoutBtn');

    function isLoggedIn() { return sessionStorage.getItem(LOGIN_KEY) === 'true'; }
    function showLogin(show) { loginModal.style.display = show ? 'flex' : 'none'; }

    if (!isLoggedIn()) showLogin(true); else showLogin(false);

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (loginUser.value === DEMO_USER.username && loginPass.value === DEMO_USER.password) {
        sessionStorage.setItem(LOGIN_KEY, 'true');
        showLogin(false);
        initApp();
      } else {
        alert('Invalid credentials');
      }
    });

    logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem(LOGIN_KEY);
      showLogin(true);
      // Reset UI
      document.getElementById('vendorGrid').innerHTML = '';
    });

    // App Elements
  const loadingEl = document.getElementById('loading');
    const emptyState = document.getElementById('emptyState');
    const vendorGrid = document.getElementById('vendorGrid');
    const vendorTpl = document.getElementById('vendorCardTpl');

  const addBtn = document.getElementById('addBtn');
  const addBtnMobile = document.getElementById('addBtnMobile');
    const exportBtn = document.getElementById('exportBtn');
    const exportBtnMobile = document.getElementById('exportBtnMobile');
    const searchInput = document.getElementById('searchInput');

    const formModal = document.getElementById('formModal');
    const formTitle = document.getElementById('formTitle');
    const closeForm = document.getElementById('closeForm');
    const vendorForm = document.getElementById('vendorForm');
  const nameInput = document.getElementById('nameInput');
  const addressInput = document.getElementById('addressInput');
  const phoneInput = document.getElementById('phoneInput');
  const activityInput = document.getElementById('activityInput');
  const imageInput = document.getElementById('imageInput');
  const imagePreview = document.getElementById('imagePreview');
  const removeImageBtn = document.getElementById('removeImageBtn');
  const cameraInput = document.getElementById('cameraInput');
  const cameraPreview = document.getElementById('cameraPreview');
  const removeCameraBtn = document.getElementById('removeCameraBtn');
    const cancelBtn = document.getElementById('cancelBtn');

  const exportSelectedBtn = document.getElementById('exportSelectedBtn');

    const IMAGE_MAX_BYTES = 2_000_000; // 2MB

  // State
  let vendors = [];
  let editingId = null; // null means creating
  let selectedVendorId = null; // currently selected vendor for quick actions

    // Storage helpers
    function storageKey(id) { return `vendor:${id}`; }

    function loadVendorsFromStorage() {
      const result = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('vendor:')) {
          try {
            const raw = localStorage.getItem(key);
            if (!raw) continue;
            const obj = JSON.parse(raw);
            // Defaults for backward compatibility
            obj.id = obj.id || key.replace('vendor:', '');
            obj.name = obj.name || '';
            obj.address = obj.address || '';
            obj.phone = obj.phone || '';
            obj.image = obj.image || '';
            // activity / what they do
            obj.activity = obj.activity || obj.whatTheyDo || '';
            // accept older field name `cameraImage` or `capturedImage`
            obj.cameraImage = obj.cameraImage || obj.capturedImage || '';
            obj.createdAt = obj.createdAt || Date.now();
            obj.updatedAt = obj.updatedAt || obj.createdAt;
            result.push(obj);
          } catch (err) {
            console.error('Failed to parse vendor', key, err);
          }
        }
      }
      // sort by createdAt desc
      result.sort((a,b) => b.createdAt - a.createdAt);
      return result;
    }

    function saveVendorToStorage(vendor) {
      try {
        localStorage.setItem(storageKey(vendor.id), JSON.stringify(vendor));
      } catch (err) {
        console.error('Failed to save vendor', err);
        alert('Failed to save vendor. localStorage quota may be exceeded.');
      }
    }

    function deleteVendorFromStorage(id) {
      localStorage.removeItem(storageKey(id));
    }

    // UI render
    function renderVendors(list) {
      vendorGrid.innerHTML = '';
      if (list.length === 0) {
        emptyState.classList.remove('hidden');
        vendorGrid.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        vendorGrid.classList.remove('hidden');
        list.forEach(v => {
          const node = vendorTpl.content.cloneNode(true);
          const article = node.querySelector('article');
          const nameEl = node.querySelector('.name');
          const addressEl = node.querySelector('.address');
          const phoneEl = node.querySelector('.phone');
          const editBtn = node.querySelector('.editBtn');
          const deleteBtn = node.querySelector('.deleteBtn');
          const callBtn = node.querySelector('.callBtn');
          const waBtn = node.querySelector('.waBtn');
          const exportVendorBtn = node.querySelector('.exportVendorBtn');
          const imageContainer = node.querySelector('.card-image');

          nameEl.textContent = v.name;
          addressEl.textContent = v.address;
          phoneEl.textContent = v.phone;
          // activity / what they do
          const activityEl = document.createElement('p');
          activityEl.className = 'text-sm text-gray-700 mt-2 activity';
          activityEl.textContent = v.activity || '';
          // insert activity after address/phone
          phoneEl.insertAdjacentElement('afterend', activityEl);

          if (v.image) {
            const img = document.createElement('img');
            img.src = v.image;
            img.alt = v.name;
            img.className = 'w-full h-44 object-cover';
            imageContainer.appendChild(img);
          } else {
            imageContainer.innerHTML = '<div class="w-full h-36 bg-gray-100 flex items-center justify-center text-gray-400">No image</div>';
          }
          // show camera-captured thumbnail if present (kept separate from main site image)
          if (v.cameraImage) {
            const camThumb = document.createElement('img');
            camThumb.src = v.cameraImage;
            camThumb.alt = v.name + ' (photo)';
            camThumb.className = 'mt-2 w-full sm:w-32 h-20 object-cover rounded';
            imageContainer.appendChild(camThumb);
          }

          // preserve selection visual if this vendor is selected
          if (selectedVendorId && selectedVendorId === v.id) {
            article.classList.add('ring-2', 'ring-blue-300');
          }

          // selection: clicking the card (not buttons) toggles selection
          article.addEventListener('click', (ev) => {
            // ignore if a button inside was clicked
            if (ev.target.closest('button')) return;
            if (selectedVendorId === v.id) {
              selectedVendorId = null;
              article.classList.remove('ring-2', 'ring-blue-300');
            } else {
              // clear previous selection visuals
              const prev = vendorGrid.querySelector('article.ring-2');
              if (prev) prev.classList.remove('ring-2', 'ring-blue-300');
              selectedVendorId = v.id;
              article.classList.add('ring-2', 'ring-blue-300');
            }
            // toggle header Export Selected visibility
            exportSelectedBtn.classList.toggle('hidden', !selectedVendorId);
          });

          // ensure call/whatsapp icons render even if lucide didn't process them
          callBtn.innerHTML = getInlineSvg('phone');
          waBtn.innerHTML = getInlineSvg('message-circle');

          editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditForm(v.id); });
          deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDelete(v.id); });
          callBtn.addEventListener('click', (e) => { e.stopPropagation(); openCall(v.phone); });
          waBtn.addEventListener('click', (e) => { e.stopPropagation(); openWhatsApp(v.phone); });
          exportVendorBtn.addEventListener('click', (e) => { e.stopPropagation(); exportVendor(v.id); });

          vendorGrid.appendChild(node);
        });
      }
      // update export visibility
      const has = list.length > 0;
      exportBtn.classList.toggle('hidden', !has);
      exportBtnMobile.classList.toggle('hidden', !has);
      document.getElementById('exportBtn')?.classList.toggle('hidden', !has);
  // no single-vendor restriction: keep Add available
    }

    // no single-vendor UI state helper (allow multiple vendors)

    // Provide inline SVGs for a couple of icons (fallback if lucide isn't applied)
    function getInlineSvg(name) {
      if (name === 'phone') {
        return `
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.86 19.86 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12 1.2.34 2.38.63 3.53a2 2 0 0 1-.45 2.11L8.09 11.91a16 16 0 0 0 6 6l1.55-1.55a2 2 0 0 1 2.11-.45c1.15.29 2.33.51 3.53.63A2 2 0 0 1 22 16.92z"/>
          </svg>`;
      }
      if (name === 'message-circle') {
        return `
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7A8.38 8.38 0 0 1 4 11.5 8.5 8.5 0 0 1 12.5 3 8.5 8.5 0 0 1 21 11.5z"/>
          </svg>`;
      }
      return '';
    }

    // Helper: sanitize phone number for tel: and wa.me links
    function sanitizePhone(phone) {
      if (!phone) return '';
      // remove spaces, parentheses, dashes, plus signs for wa.me (wa requires country code without '+')
      return phone.replace(/[^0-9+]/g, '');
    }

    function openCall(phone) {
      const sanitized = sanitizePhone(phone);
      if (!sanitized) return alert('No phone number available');
      window.location.href = `tel:${sanitized}`;
    }

    function openWhatsApp(phone) {
      let sanitized = sanitizePhone(phone);
      if (!sanitized) return alert('No phone number available');
      // remove leading + if present for wa.me
      if (sanitized.startsWith('+')) sanitized = sanitized.slice(1);
      const url = `https://wa.me/${sanitized}`;
      window.open(url, '_blank');
    }

    // Export a single vendor as CSV (images are excluded from CSV)
    function exportVendor(id) {
      const v = vendors.find(x => x.id === id);
      if (!v) { alert('Vendor not found'); return; }
      // CSV headers and row (exclude image fields to keep CSV compact)
  const headers = ['id','name','address','phone','activity','createdAt','updatedAt'];
      const row = [v.id, v.name, v.address, v.phone, v.createdAt, v.updatedAt];
      const escape = (s) => `"${String(s || '').replace(/"/g,'""')}"`;
      const csv = headers.join(',') + '\n' + row.map(escape).join(',') + '\n';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vendor_${(v.name || v.id).replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-]/g,'')}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // CRUD handlers
    function openAddForm() {
      editingId = null;
      formTitle.textContent = 'Add Vendor';
      nameInput.value = '';
      addressInput.value = '';
      phoneInput.value = '';
      activityInput.value = '';
      imagePreview.src = '';
      imagePreview.classList.add('hidden');
      removeImageBtn.classList.add('hidden');
      imageInput.value = '';
      // clear camera preview for new form
      cameraPreview.src = '';
      cameraPreview.classList.add('hidden');
      removeCameraBtn.classList.add('hidden');
      cameraInput.value = '';
      formModal.style.display = 'flex';
      lucide && lucide.createIcons();
    }

    function openEditForm(id) {
      const v = vendors.find(x => x.id === id);
      if (!v) return alert('Vendor not found');
      editingId = id;
      formTitle.textContent = 'Edit Vendor';
      nameInput.value = v.name;
      addressInput.value = v.address;
      phoneInput.value = v.phone;
      activityInput.value = v.activity || '';
      if (v.image) {
        imagePreview.src = v.image;
        imagePreview.classList.remove('hidden');
        removeImageBtn.classList.remove('hidden');
      } else {
        imagePreview.src = '';
        imagePreview.classList.add('hidden');
        removeImageBtn.classList.add('hidden');
      }
      imageInput.value = '';
      // camera image
      if (v.cameraImage) {
        cameraPreview.src = v.cameraImage;
        cameraPreview.classList.remove('hidden');
        removeCameraBtn.classList.remove('hidden');
      } else {
        cameraPreview.src = '';
        cameraPreview.classList.add('hidden');
        removeCameraBtn.classList.add('hidden');
      }
      formModal.style.display = 'flex';
      lucide && lucide.createIcons();
    }

    function closeFormModal() {
      formModal.style.display = 'none';
      // reset editing state and form contents
      editingId = null;
      nameInput.value = '';
      addressInput.value = '';
      phoneInput.value = '';
      activityInput.value = '';
      imagePreview.src = '';
      imagePreview.classList.add('hidden');
      removeImageBtn.classList.add('hidden');
      imageInput.value = '';
      // reset camera-related fields
      cameraPreview.src = '';
      cameraPreview.classList.add('hidden');
      removeCameraBtn.classList.add('hidden');
      cameraInput.value = '';
    }

    async function handleDelete(id) {
      const v = vendors.find(x=>x.id===id);
      if (!v) return alert('Vendor not found');
      const ok = confirm(`Are you sure you want to delete "${v.name}"? This action cannot be undone.`);
      if (!ok) return;
      deleteVendorFromStorage(id);
      vendors = loadVendorsFromStorage();
      applySearchFilter();
  // No single-vendor enforcement; Add buttons remain available
    }

    function generateId() { return `vendor_${Date.now()}`; }

    vendorForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      const phone = phoneInput.value.trim();
      if (!name || !address || !phone) { alert('Please fill in required fields'); return; }

      const now = Date.now();
      if (editingId) {
        const vendor = vendors.find(v=>v.id===editingId);
        if (!vendor) { alert('Vendor not found'); return; }
        vendor.name = name;
        vendor.address = address;
        vendor.phone = phone;
        vendor.activity = activityInput.value.trim();
        vendor.updatedAt = now;
        // set image fields explicitly (empty string if removed)
        vendor.image = imagePreview.src || '';
        vendor.cameraImage = cameraPreview.src || '';
        saveVendorToStorage(vendor);
      } else {
        const id = generateId();
        const vendor = {
          id,
          name,
          address,
          phone,
          image: imagePreview.src || '',
          activity: activityInput.value.trim() || '',
          cameraImage: cameraPreview.src || '',
          createdAt: now,
          updatedAt: now
        };
        saveVendorToStorage(vendor);
      }
      vendors = loadVendorsFromStorage();
      applySearchFilter();
      closeFormModal();
    });

    // Image handling
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (file.size > IMAGE_MAX_BYTES) {
        alert('Image size should be less than 2MB');
        imageInput.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        imagePreview.src = reader.result;
        imagePreview.classList.remove('hidden');
        removeImageBtn.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    });

    // camera capture input handling (separate image)
    cameraInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (file.size > IMAGE_MAX_BYTES) {
        alert('Image size should be less than 2MB');
        cameraInput.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        cameraPreview.src = reader.result;
        cameraPreview.classList.remove('hidden');
        removeCameraBtn.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    });

    removeImageBtn.addEventListener('click', () => {
      imagePreview.src = '';
      imagePreview.classList.add('hidden');
      removeImageBtn.classList.add('hidden');
      imageInput.value = '';
    });

    removeCameraBtn.addEventListener('click', () => {
      cameraPreview.src = '';
      cameraPreview.classList.add('hidden');
      removeCameraBtn.classList.add('hidden');
      cameraInput.value = '';
    });

    // close modal when clicking outside content
    formModal.addEventListener('click', (e) => {
      if (e.target === formModal) closeFormModal();
    });

    // close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (formModal.style.display === 'flex') closeFormModal();
      }
    });

    cancelBtn.addEventListener('click', () => closeFormModal());
    closeForm.addEventListener('click', () => closeFormModal());
    addBtn.addEventListener('click', () => openAddForm());
    addBtnMobile.addEventListener('click', () => openAddForm());

    // Search & filter
    function applySearchFilter() {
      const q = (searchInput.value || '').toLowerCase().trim();
      const filtered = vendors.filter(v =>
        v.name.toLowerCase().includes(q) ||
        v.address.toLowerCase().includes(q) ||
        v.phone.toLowerCase().includes(q)
      );
      renderVendors(filtered);
      lucide && lucide.createIcons();
    }

    searchInput.addEventListener('input', () => applySearchFilter());

    // Export
    // Export all vendors as CSV (images excluded to keep file size reasonable)
    function exportAll() {
      const all = vendors;
      if (!all.length) { alert('No vendors to export'); return; }
      const headers = ['id','name','address','phone','createdAt','updatedAt'];
      const escape = (s) => `"${String(s || '').replace(/"/g,'""')}"`;
  const rows = all.map(v => [v.id, v.name, v.address, v.phone, v.activity || '', v.createdAt, v.updatedAt].map(escape).join(','));
      const csv = headers.join(',') + '\n' + rows.join('\n') + '\n';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vendors_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    exportBtn.addEventListener('click', exportAll);
    exportBtnMobile.addEventListener('click', exportAll);
    exportSelectedBtn.addEventListener('click', () => {
      if (!selectedVendorId) return alert('No vendor selected');
      exportVendor(selectedVendorId);
      // clear selection after export
      const prev = vendorGrid.querySelector('article.ring-2');
      if (prev) prev.classList.remove('ring-2', 'ring-blue-300');
      selectedVendorId = null;
      exportSelectedBtn.classList.add('hidden');
    });

    // Initial app boot
    function initApp() {
      // simulate loading state briefly for UX
      loadingEl.classList.remove('hidden');
      emptyState.classList.add('hidden');
      vendorGrid.classList.add('hidden');
      setTimeout(() => {
        vendors = loadVendorsFromStorage();
        applySearchFilter();
        loadingEl.classList.add('hidden');
      }, 250);
      // show logout if logged
      logoutBtn.classList.toggle('hidden', !isLoggedIn());
    }

    // Kick off if already logged in
    if (isLoggedIn()) initApp();

    // convenience: create demo data if none exists (comment out if undesired)
    // if (isLoggedIn() && loadVendorsFromStorage().length === 0) createDemoData();

    // Optional demo generator
    function createDemoData() {
      const sample = [
        { name: 'Acme Supplies', address: '123 Main St, Springfield', phone: '+1-555-0100' },
        { name: 'Blue Ridge Goods', address: '78 Ridge Ave, Asheville', phone: '+1-555-0200' },
        { name: 'Cornerstone LLC', address: '9 Oak Blvd, Metropolis', phone: '+1-555-0300' }
      ];
      sample.forEach(s => {
        const now = Date.now();
        const v = { id: generateId(), name: s.name, address: s.address, phone: s.phone, image:'', createdAt: now, updatedAt: now };
        saveVendorToStorage(v);
      });
      vendors = loadVendorsFromStorage();
      applySearchFilter();
    }

  </script>
</body>
</html>
